# 功能规格说明: 家庭记账本用户系统

**功能分支**: `001-user-system`
**创建日期**: 2026-02-07
**状态**: 草稿
**输入**: 用户描述: "网页的竖版应用。发布在 Vercel 上。支持用户系统,后台数据库。前端已完成,需要拷贝到合适位置并添加用户系统。"

## 澄清记录

### 会话 2026-02-07

- Q: 数据同步粒度（长按连续增减时是否每次都同步） → A: +1/-1/+10/-10 按钮只修改输入框数字，不触发后端同步；仅在实际数据变更（应用余额、增删成员等）时同步
- Q: 注册模式与管理员功能 → A: 用户名+密码注册（非邮箱），任何人可注册；新增管理员角色，管理员账号在 .env 配置，管理员页面可删除用户、重置密码

## 用户场景与测试 *(必填)*

### 用户故事 1 - 用户注册与登录 (优先级: P1)

作为新用户，我想要注册一个账号并登录，这样我的记账数据可以
保存在云端，换设备也不会丢失。

**优先级理由**: 用户系统是所有云端功能的基础，没有登录就无法
区分不同用户的数据。

**独立测试**: 用户可以通过注册页面创建账号，然后用账号密码
登录，登录后看到空白的记账界面。

**验收场景**:

1. **给定** 用户首次访问应用，**当** 点击注册，**那么** 看到
   注册表单（用户名、密码、确认密码）
2. **给定** 用户填写了有效的注册信息，**当** 提交注册，**那么**
   账号创建成功并自动登录进入主界面
3. **给定** 用户已有账号，**当** 在登录页输入正确的用户名和密码，
   **那么** 成功登录并看到自己的记账数据
4. **给定** 用户输入了错误的密码，**当** 提交登录，**那么**
   看到明确的错误提示，不泄露账号是否存在
5. **给定** 用户已经登录，**当** 关闭浏览器后再次打开应用，
   **那么** 仍然保持登录状态

---

### 用户故事 2 - 云端数据同步 (优先级: P2)

作为已登录用户，我想要我的家庭成员和交易记录保存在云端数据库
中，这样数据不会因为清除浏览器缓存而丢失。

**优先级理由**: 数据持久化是用户系统的核心价值。当前数据仅存在
localStorage 中，清除缓存即丢失。

**独立测试**: 用户登录后添加家庭成员和交易记录，刷新页面或换
设备登录后数据仍然存在。

**验收场景**:

1. **给定** 用户已登录，**当** 添加一个家庭成员，**那么** 该
   成员数据保存到云端数据库
2. **给定** 用户已登录并有数据，**当** 在另一台设备上登录同一
   账号，**那么** 看到完全一致的家庭成员和交易记录
3. **给定** 用户已登录，**当** 点击"应用"执行余额增减操作，
   **那么** 交易记录保存到云端（输入框数字变更不触发同步）
4. **给定** 用户已登录，**当** 清除浏览器缓存后重新打开应用，
   **那么** 登录后所有数据完整恢复

---

### 用户故事 3 - 退出登录 (优先级: P3)

作为已登录用户，我想要能够退出登录，这样可以在共享设备上保护
我的数据隐私。

**优先级理由**: 退出功能是用户系统的基本安全保障，优先级低于
核心登录和数据同步。

**独立测试**: 用户点击退出按钮后回到登录页面，再次访问应用需要
重新登录。

**验收场景**:

1. **给定** 用户已登录，**当** 点击退出登录按钮，**那么** 回到
   登录页面，本地会话被清除
2. **给定** 用户已退出，**当** 直接访问应用主页，**那么** 被
   重定向到登录页面

---

### 用户故事 4 - 管理员管理用户 (优先级: P4)

作为管理员，我想要能够查看所有用户、删除用户和重置用户密码，
这样可以维护系统秩序和帮助忘记密码的用户。

**优先级理由**: 管理功能是运营保障，优先级低于核心用户功能，
但解决了首版不支持自助密码找回的问题。

**独立测试**: 使用 .env 中配置的管理员账号登录后，可以看到
管理员页面入口，进入后能看到用户列表并执行管理操作。

**验收场景**:

1. **给定** 用管理员账号登录，**当** 进入管理员页面，**那么**
   看到所有注册用户的列表（用户名、注册时间）
2. **给定** 管理员在用户列表中，**当** 点击删除某用户，**那么**
   该用户及其所有数据被删除
3. **给定** 管理员在用户列表中，**当** 点击重置某用户密码，
   **那么** 该用户密码被重置为系统生成的新密码并显示给管理员
4. **给定** 用普通用户账号登录，**当** 尝试访问管理员页面，
   **那么** 被拒绝访问

---

### 边缘场景

- 用户注册时使用已存在的用户名会怎样？→ 提示"该用户名已被占用"
- 用户忘记密码怎么办？→ 联系管理员，管理员可重置密码
- 网络断开时操作数据会怎样？→ 显示网络错误提示，阻止数据操作
- 同一账号在多设备同时操作会怎样？→ 以最后一次保存为准，不做
  实时冲突解决
- 管理员删除用户时该用户正在线怎样？→ 该用户下次请求时被强制
  登出

## 需求 *(必填)*

### 功能需求

- **FR-001**: 系统必须（MUST）提供用户名+密码的注册功能，
  任何人可注册
- **FR-002**: 系统必须（MUST）提供用户名+密码的登录功能
- **FR-003**: 系统必须（MUST）在用户未登录时将其重定向到登录页
- **FR-004**: 系统必须（MUST）在登录成功后维持会话状态（关闭
  浏览器后重新打开仍保持登录）
- **FR-005**: 系统必须（MUST）提供退出登录功能
- **FR-006**: 系统必须（MUST）将家庭成员数据（姓名、日薪、余额）
  持久化到后台数据库
- **FR-007**: 系统必须（MUST）将交易记录持久化到后台数据库
- **FR-008**: 系统必须（MUST）在用户登录后从数据库加载其所有数据
- **FR-009**: 系统必须（MUST）确保每个用户只能访问自己的数据
- **FR-010**: 密码必须（MUST）以安全方式存储，禁止明文保存
- **FR-011**: 系统必须（MUST）将现有前端代码从 backup 目录拷贝到
  项目正式目录并集成用户系统
- **FR-012**: 系统必须（MUST）可部署到 Vercel 平台
- **FR-013**: 系统必须（MUST）支持管理员角色，管理员账号通过
  .env 环境变量配置
- **FR-014**: 管理员必须（MUST）能查看所有注册用户列表
- **FR-015**: 管理员必须（MUST）能删除用户（同时删除其所有数据）
- **FR-016**: 管理员必须（MUST）能重置用户密码
- **FR-017**: 系统必须（MUST）仅在实际数据变更时同步后端（余额
  应用、增删成员等），前端输入框操作不触发同步

### 关键实体

- **用户 (User)**: 应用的注册用户，包含用户名、密码哈希、
  是否管理员标记、创建时间
- **家庭成员 (Person)**: 属于某个用户的家庭成员，包含姓名、日薪、
  余额，与用户为多对一关系
- **交易记录 (Transaction)**: 属于某个家庭成员的收支记录，包含
  类型（增加/减少/清空/日薪）、金额、时间戳、描述

## 成功标准 *(必填)*

### 可衡量的结果

- **SC-001**: 用户可以在 30 秒内完成注册流程
- **SC-002**: 用户可以在 15 秒内完成登录流程
- **SC-003**: 数据操作（增减余额、添加成员）后在 2 秒内同步到
  云端
- **SC-004**: 换设备登录后 100% 的数据完整恢复
- **SC-005**: 应用可通过 Vercel 公网地址正常访问
- **SC-006**: 未登录用户无法访问任何记账数据
- **SC-007**: 管理员可在管理页面完成用户删除和密码重置操作

## 假设

- 首版用户量较小（<100 人），无需考虑高并发优化
- 使用用户名+密码作为唯一认证方式，暂不支持第三方登录
- 用户忘记密码通过管理员重置解决
- 首版不实现多设备实时同步（冲突解决），以最后保存为准
- 现有前端的 undo/redo 功能仅在当前会话内有效，不持久化历史栈
- 前端 UI 保持现有 iOS 风格不变，新增登录/注册页面和管理员页面
- 管理员账号数量较少，通过 .env 配置用户名即可标识
